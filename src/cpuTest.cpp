#include "cpu.h"
#include <fstream>
#include <assert.h>
// printf("0x%x\n", S->PC);


int main(){


    //initialize CPUState
    CPUState* S = (CPUState*) calloc(sizeof(CPUState), 1);
    initialize(S);

    //BCC --------------------------------------------------------------------------------------------------------------------------------------
    //branch on carry clear

    //test branch
    S->C = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x90;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0x90;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    
    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0x90;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->C = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x90;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);

    //BCS --------------------------------------------------------------------------------------------------------------------------------------

    //test branch
    S->C = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0xB0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0xB0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);

    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0xB0;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->C = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0xB0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);



    //BEQ --------------------------------------------------------------------------------------------------------------------------------------

    //test branch
    S->Z = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0xF0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0xF0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);

    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0xF0;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->Z = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0xF0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);

    //BMI --------------------------------------------------------------------------------------------------------------------------------------

    //test branch
    S->N = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x30;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0x30;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);

    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0x30;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->N = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x30;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);

    //BNE --------------------------------------------------------------------------------------------------------------------------------------

    //test branch
    S->Z = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0xD0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0xD0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);

    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0xD0;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->Z = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0xD0;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);

    //BPL --------------------------------------------------------------------------------------------------------------------------------------

    //test branch
    S->N = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x10;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0x10;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);

    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0x10;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->N = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x10;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);

    //BRK --------------------------------------------------------------------------------------------------------------------------------------

    //BVC --------------------------------------------------------------------------------------------------------------------------------------

    //test branch
    S->V = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x50;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0x50;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);

    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0x50;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->V = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x50;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);

    //BVS --------------------------------------------------------------------------------------------------------------------------------------

    //test branch
    S->V = 1;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x70;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1000 + 4 + 2);
    assert(S->cycleDif == 3);

    S->PC = 0x1FFD;
    S->memory[S->PC] = 0x70;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);

    assert(S->PC == 0x1FFD + 4 + 2);
    assert(S->cycleDif == 4);

    //test negative travel
    S->PC = 0x1000;
    S->memory[S->PC] = 0x70;
    S->memory[S->PC + 1] = 0xFC; 
    Run(S);
    assert(S->PC == 0x1000 - 4 + 2 );

    //test branch not taken
    S->V = 0;
    S->PC = 0x1000;
    S->memory[S->PC] = 0x70;
    S->memory[S->PC + 1] = 0x04; 
    Run(S);
    assert(S->PC == 0x1002);
    assert(S->cycleDif == 2);

    //CLC --------------------------------------------------------------------------------------------------------------------------------------

    //CLD --------------------------------------------------------------------------------------------------------------------------------------

    //CLI --------------------------------------------------------------------------------------------------------------------------------------

    //CLV --------------------------------------------------------------------------------------------------------------------------------------

    //DEX --------------------------------------------------------------------------------------------------------------------------------------

    //DEY --------------------------------------------------------------------------------------------------------------------------------------

    //INX --------------------------------------------------------------------------------------------------------------------------------------
    
    //INY --------------------------------------------------------------------------------------------------------------------------------------

    //NOP --------------------------------------------------------------------------------------------------------------------------------------

    //PHA --------------------------------------------------------------------------------------------------------------------------------------

    //PHP --------------------------------------------------------------------------------------------------------------------------------------

    //PLA --------------------------------------------------------------------------------------------------------------------------------------

    //PLP --------------------------------------------------------------------------------------------------------------------------------------

    //RTI --------------------------------------------------------------------------------------------------------------------------------------

    //RTS --------------------------------------------------------------------------------------------------------------------------------------

    //SEC --------------------------------------------------------------------------------------------------------------------------------------

    //SED --------------------------------------------------------------------------------------------------------------------------------------

    //SEI --------------------------------------------------------------------------------------------------------------------------------------

    //TAX --------------------------------------------------------------------------------------------------------------------------------------

    //TAY --------------------------------------------------------------------------------------------------------------------------------------

    //TSX --------------------------------------------------------------------------------------------------------------------------------------

    //TXA --------------------------------------------------------------------------------------------------------------------------------------

    //TXS --------------------------------------------------------------------------------------------------------------------------------------

    //TYA --------------------------------------------------------------------------------------------------------------------------------------
    
    printf("Everything works! :)\n");
}

